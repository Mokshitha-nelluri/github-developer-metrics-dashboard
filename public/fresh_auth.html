<!DOCTYPE html>
<html>
<head>
  <title>Fresh GitHub Authentication</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    .login-btn {
      background: #24292e;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
      width: 100%;
      justify-content: center;
      margin-bottom: 10px;
    }
    .login-btn:hover {
      background: #444d56;
    }
    .login-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ðŸ”„ Fresh Account Login</h2>
    <p>Sign in with a different GitHub account</p>
    
    <button id="login-btn" class="login-btn">
      <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
      </svg>
      Sign in with GitHub
    </button>
    
    <div id="status" class="status"></div>
  </div>

  <script>
    async function initializeFreshAuth() {
      // Get Supabase config
      const urlParams = new URLSearchParams(window.location.search);
      const supabaseUrl = urlParams.get('supabase_url') || 'https://vlqpjibikxahckqvpdyc.supabase.co';
      const supabaseKey = urlParams.get('supabase_key') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZscXBqaWJpa3hhaGNrcXZwZHljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NzYxNzAsImV4cCI6MjA2OTA1MjE3MH0.LPezRjCbvIgmbhERtRLBo1QZrz-Kn8n3SUhUzpZKT7Q';
      
      console.log('ðŸ†• FRESH AUTH: Complete session isolation mode');
      
      // NUCLEAR CLEAR: Destroy everything before initializing
      try {
        localStorage.clear();
        sessionStorage.clear();
        
        // Clear all cookies aggressively
        document.cookie.split(";").forEach(function(c) { 
          const cookie = c.replace(/^ +/, "").replace(/=.*/, "");
          ['/', '/public/', '/auth/'].forEach(path => {
            ['', '.localhost', 'localhost', window.location.hostname].forEach(domain => {
              if (domain) {
                document.cookie = `${cookie}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=${path};domain=${domain}`;
              } else {
                document.cookie = `${cookie}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=${path}`;
              }
            });
          });
        });
        
        // Clear IndexedDB
        if (window.indexedDB) {
          ['supabase-auth', 'supabase', 'auth-storage'].forEach(dbName => {
            try {
              window.indexedDB.deleteDatabase(dbName);
            } catch (e) {
              console.log(`IndexedDB ${dbName} clear error (expected):`, e);
            }
          });
        }
        
        console.log('âœ… FRESH AUTH: All storage cleared');
      } catch (e) {
        console.log('Storage clear error (expected):', e);
      }
      
      // Wait for clearing to complete
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Create completely isolated Supabase client
      const freshSupabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
        auth: {
          autoRefreshToken: false,
          persistSession: false,
          detectSessionInUrl: false,
          flowType: 'pkce',
          storageKey: `fresh-auth-${Date.now()}-${Math.random()}`,
          storage: {
            getItem: (key) => {
              console.log(`ðŸš« FRESH STORAGE: getItem(${key}) -> null`);
              return null; // Never return existing data
            },
            setItem: (key, value) => {
              console.log(`ðŸš« FRESH STORAGE: setItem(${key}) -> ignored`);
              // Don't persist anything
            },
            removeItem: (key) => {
              console.log(`ðŸš« FRESH STORAGE: removeItem(${key}) -> ignored`);
              // Nothing to remove
            }
          }
        }
      });
      
      const loginBtn = document.getElementById('login-btn');
      const statusDiv = document.getElementById('status');
      
      function showStatus(message, type = 'success') {
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`;
        statusDiv.style.display = 'block';
      }
      
      // Handle login
      async function handleFreshLogin() {
        try {
          loginBtn.disabled = true;
          loginBtn.textContent = 'Starting fresh authentication...';
          
          showStatus('ðŸ§¹ Ensuring clean session state...', 'info');
          
          // Force sign out any remaining sessions
          try {
            await freshSupabase.auth.signOut({ scope: 'global' });
          } catch (e) {
            console.log('Signout error (expected):', e);
          }
          
          showStatus('ðŸš€ Starting GitHub OAuth flow...', 'info');
          
          // Start OAuth with maximum fresh parameters
          const { data, error } = await freshSupabase.auth.signInWithOAuth({
            provider: 'github',
            options: {
              redirectTo: `${window.location.origin}/public/auth_enhanced.html?fresh_auth=true&timestamp=${Date.now()}`,
              scopes: 'repo read:user user:email',
              queryParams: {
                prompt: 'select_account',
                force_fresh: 'true',
                timestamp: Date.now().toString(),
                cache_bust: Math.random().toString(36).substring(7),
                fresh_session: 'true'
              }
            }
          });
          
          if (error) {
            throw error;
          }
          
          showStatus('âœ… Redirecting to GitHub...', 'success');
          
        } catch (error) {
          console.error('Fresh login error:', error);
          showStatus(`Login failed: ${error.message}`, 'error');
          
          loginBtn.disabled = false;
          loginBtn.innerHTML = `
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
            </svg>
            Sign in with GitHub
          `;
        }
      }
      
      loginBtn.onclick = handleFreshLogin;
      
      showStatus('ðŸ†• Ready for fresh authentication', 'success');
      console.log('âœ… FRESH AUTH: Ready for completely fresh login');
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeFreshAuth);
    } else {
      initializeFreshAuth();
    }
  </script>
</body>
</html>
